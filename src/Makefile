# This Makefile is not really a
# dependency tracking makefile, it just
# calls `dune`

MO_IDE_TARGET = _build/default/exes/mo_ide.exe
MO_LD_TARGET = _build/default/exes/mo_ld.exe
MOC_TARGET = _build/default/exes/moc.exe
DIDC_TARGET = _build/default/exes/didc.exe
MOC_JS_TARGET = _build/default/js/mo_js.bc.js
DESER_TARGET = _build/default/exes/deser.exe

DUNE_OPTS ?=

ALL_TARGETS = $(MO_IDE_TARGET) $(MO_LD_TARGET) $(MOC_TARGET) $(MOC_JS_TARGET) $(DIDC_TARGET) $(DESER_TARGET)

.PHONY: all clean moc mo-ide mo-ld moc.js didc deser unit-tests

# This targets is spelled out so that `make`
# only invokes `dune` once, much faster
all:
	dune build $(DUNE_OPTS) $(ALL_TARGETS)
	@ln -fs $(MOC_TARGET) moc
	@ln -fs $(MO_IDE_TARGET) mo-ide
	@ln -fs $(MO_LD_TARGET) mo-ld
	@ln -fs $(MOC_JS_TARGET) moc.js
	@ln -fs $(DIDC_TARGET) didc
	@ln -fs $(DESER_TARGET) deser

moc:
	dune build $(DUNE_OPTS) $(MOC_TARGET)
	@ln -fs $(MOC_TARGET) moc

mo-ide:
	dune build $(DUNE_OPTS) $(MO_IDE_TARGET)
	@ln -fs $(MO_IDE_TARGET) mo-ide

mo-ld:
	dune build $(DUNE_OPTS) $(MO_LD_TARGET)
	@ln -fs $(MO_LD_TARGET) mo-ld

moc.js:
	dune build $(DUNE_OPTS) $(MOC_JS_TARGET)
	@ln -fs $(MOC_JS_TARGET) moc.js

didc:
	dune build $(DUNE_OPTS) $(DIDC_TARGET)
	@ln -fs $(DIDC_TARGET) didc

deser:
	dune build $(DUNE_OPTS) $(DESER_TARGET)
	@ln -fs $(DESER_TARGET) deser

unit-tests:
	dune runtest $(DUNE_OPTS)

clean:
	rm -f moc mo-ide mo-ld moc.js didc deser
	dune clean

test: $(NAME)
	make -C ../test MOC=$(MOC) all
	make -C ../stdlib MOC=$(MOC) all
	make -C ../samples MOC=$(MOC) all

test-quick: $(NAME)
	make -C ../test MOC=$(MOC) quick
